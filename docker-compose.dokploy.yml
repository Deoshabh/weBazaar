version: "3.8"

services:
  # ============================================
  # VALKEY / REDIS CACHE
  # ============================================
  valkey:
    image: valkey/valkey:8.1.4
    restart: unless-stopped

    # Log rotation to prevent disk exhaustion
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Redis server with password protection
    command: valkey-server --requirepass ${VALKEY_PASSWORD}

    # Health check
    healthcheck:
      test: ["CMD-SHELL", 'valkey-cli -a "${VALKEY_PASSWORD}" ping | grep PONG']
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

    # Persistent volume for data
    volumes:
      - valkey-data:/data

    # Shared network so backend can reach valkey by hostname
    networks:
      - webazaar-shared

    # Expose only internally (shared network)
    expose:
      - "6379"

# ============================================
# NETWORKS
# ============================================
networks:
  webazaar-shared:
    name: webazaar-shared
    driver: bridge

# ============================================
# VOLUMES
# ============================================
volumes:
  valkey-data:
    driver: local
